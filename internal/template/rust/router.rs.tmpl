// Code generated by {{.PluginName}}. DO NOT EDIT.

{{if .HasImportFor templateName}}
{{- range .GetTemplateImports templateName}}
use {{.Alias}};
{{- end}}
{{- end}}

use crate::{{.ModuleName}};{{$moduleName := .ModuleName}}{{$kind := .TemplateKind}}

{{range .DomainMessages -}}
#[derive(Serialize)]
struct {{.WireName}} {
    {{- range .Fields}}
    pub {{.ProtoName}}: {{.TypeByTemplateKind $kind}},
    {{- end}}
}

impl From<{{$moduleName}}::{{.Name}}> for {{.WireName}} {
    fn from(m: {{$moduleName}}::{{.Name}}) -> Self {
        Self {
        {{- range .Fields}}
            {{.ProtoName}}: m.{{.ProtoName}},
        {{- end}}
        }
    }
}

{{end -}}

{{range .WireInputMessages -}}
#[derive(Deserialize)]
struct {{.Name}} {
    {{- range .Fields}}
    pub {{.ProtoName}}: {{.TypeByTemplateKind $kind}},
    {{- end}}
}

impl From<{{.Name}}> for {{$moduleName}}::{{.Name}} {
    fn from(m: {{.Name}}) -> Self {
        Self {
        {{- range .Fields}}
            {{.ProtoName}}: m.{{.ProtoName}},
        {{- end}}
        }
    }
}

{{end -}}

{{range .OutboundMessages -}}
#[derive(Serialize)]
struct {{.Name}} {
    {{- range .Fields}}
    pub {{.ProtoName}}: {{.TypeByTemplateKind $kind}},
    {{- end}}
}

impl From<{{$moduleName}}::{{.Name}}> for {{.Name}} {
    fn from(m: {{$moduleName}}::{{.Name}}) -> Self {
        Self {
        {{- range .Fields}}
            {{.ProtoName}}: {{.ConvertWireOutputToOutboundByTemplateKind $kind "m"}},
        {{- end}}
        }
    }
}

{{end -}}

{{range .Methods -}}
{{if .HasBodyArguments}}
#[derive(Deserialize)]
struct {{.RequestType}}Body {
    {{- range .BodyArguments}}
    pub {{.ProtoName}}: {{.Field.TypeByTemplateKind $kind}},
    {{- end}}
}
{{end}}
{{if .HasQueryArguments}}
#[derive(Deserialize)]
struct {{.RequestType}}Query {
    {{- range .QueryArguments}}
    pub {{.ProtoName}}: {{.Field.TypeByTemplateKind $kind}},
    {{- end}}
}
{{end}}

async fn {{toSnake .Name}}(
    State(state): State<Arc<mikros::Mutex<ServiceState>>>,
    Extension(router): Extension<Router>,
{{- if .HasHeaderArguments}}
    headers: HeaderMap,
{{- end}}
{{- if .HasPathArguments}}
    Path({{.GetPathParameterNames}}): Path<{{.GetPathParameterTypesByTemplateKind $kind}}>,
{{- end}}
{{- if .HasQueryArguments}}
    Query(query): Query<{{.RequestType}}Query>,
{{- end}}
{{- if .HasBodyArguments}}
    Json(body): Json<{{.RequestType}}Body>,
{{- end}}
) -> Result<Json<{{.ResponseType}}>, merrors::ServiceError> {
    let context = state.lock().await.context();

    // Retrieve all arguments to create the endpoint main structure.
    let args = {{.RequestType}} {
        {{- if .HasPathArguments}}
        {{- range .PathArguments}}
        {{.ProtoName}}: {{.ProtoName}},
        {{- end}}
        {{- end}}
        {{- if .HasHeaderArguments}}
        {{- range .HeaderArguments}}
        {{.ProtoName}}: {{.Field.HeaderArgumentByTemplateKind $kind}},
        {{- end}}
        {{- end}}
        {{- if .HasQueryArguments}}
        {{- range .QueryArguments}}
        {{.ProtoName}}: query.{{.ProtoName}},
        {{- end}}
        {{- end}}
        {{- if .HasBodyArguments}}
        {{- range .BodyArguments}}
        {{.ProtoName}}: body.{{.ProtoName}},
        {{- end}}
        {{- end}}
    };

    let input: {{$moduleName}}::{{.RequestType}} = args.into();
    let mut request = Request::new(input);

    // Adds mikros context inside the request for the wrapper to also access it.
    request.extensions_mut().insert(context.clone());

    // Translates the wrapper response into the endpoint response.
    match router.wrapper.{{toSnake .Name}}(request).await {
        Ok(response) => Ok(Json(response.into_inner().into())),
        Err(error) => {
            let e: merrors::ServiceError = error.into();
            Err(e.into())
        }
    }
}
{{end}}

#[derive(Clone)]
pub struct Router {
    wrapper: Arc<dyn {{.ModuleName}}::{{toSnake .ServiceName}}_server::{{.ServiceName}}>,
}

impl Router {
    pub fn new(server: Arc<dyn {{.ModuleName}}::{{toSnake .ServiceName}}_server::{{.ServiceName}}>) -> Self {
        Self {
            wrapper: server,
        }
    }

    pub fn routes(self) -> axum::Router<Arc<mikros::Mutex<ServiceState>>> {
        axum::Router::new()
            {{- range .Methods}}
            .route("{{.EndpointByTemplateKind $kind}}", {{lower .HTTPMethod}}({{toSnake .Name}}))
            {{- end}}
            .layer(Extension(self.clone()))
    }
}
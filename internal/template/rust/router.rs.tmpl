/// Code generated by {{.PluginName}}. DO NOT EDIT.
use std::sync::Arc;

use axum::extract::{Extension, State};
use axum::routing::{{{lower .HTTPMethods}}}
use mikros::http::ServiceState;
use serde_derive::{Deserialize, Serialize};
use tonic::Request;

use crate::{{.ModuleName}};{{$moduleName := .ModuleName}}

{{range .WireInputMessages -}}
#[derive(Deserialize)]
pub struct {{.Name}};

impl From<{{.Name}}> for {{$moduleName}}::{{.Name}} {
    fn from(m: {{.Name}}) -> Self {
        Self {}
    }
}

// if has path parameters declare new struct
// if has header parameters declare new struct
// if has query parameters declare new struct

{{- end}}

{{range .OutboundMessages -}}
#[derive(Serialize)]
pub struct {{.Name}};

impl From<{{$moduleName}}::{{.Name}}> for {{.Name}} {
    fn from(m: {{$moduleName}}::{{.Name}}) -> Self {
        Self {}
    }
}
{{- end}}

pub struct Router {
    wrapper: Arc<dyn {{.ModuleName}}::{{.ModuleName}}_server::{{.ServiceName}}>,
}

{{range .Methods -}}
pub async fn {{toSnake .Name}}(
    State(state): State<Arc<mikros::Mutex<ServiceState>>>,
    Extension(router): Extension<Router>,
) -> Json<{{.ResponseName}}> {
    // FIXME: adjust the main struct creation

    // Retrieve endpoint arguments (body, path, query and header).
    let input: {{$moduleName}}::{{.Name}} = body.into();
    let mut request = Request::new(input);

    // Adds mikros context inside the request for the wrapper to also access it.
    let context = state.lock().await.context();
    request.extensions_mut().insert(context.clone());

    // TODO: Handle errors properly
    // Translates the wrapper response into the endpoint response.
    let res = router.wrapper.say_hello(request).await.unwrap();
    Json(res.into_inner().into())
}
{{- end}}

#[derive(Clone)]
impl Router {
    pub fn new(server: Arc<dyn {{.ModuleName}}::{{.ModuleName}}_server::{{.ServiceName}}>) -> Self {
        Self {
            wrapper: server,
        }
    }

    pub fn routes(self) -> axum::Router<Arc<mikros::Mutex<ServiceState>>> {
        axum::Router::new()
            {{- range .Methods}}{{$kind .TemplateKind}}
            .route("{{.EndpointByTemplateKind $kind}}", {{lower .HTTPMethod}}({{toSnake .Name}}))
            {{- end}}
            .layer(Extension(self.clone()))
    }
}